<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Winton CRM</title>
    <!-- Iconos Phosphor -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        :root {
            --primary: #007bff;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg: #0f172a;
            --card-bg: #1e293b;
            --sidebar-bg: #111827;
            --text: #f8fafc;
            --border: #374151;
        }

        * {
            box-sizing: border-box;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Inter', system-ui, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* SIDEBAR SCRIPTS */
        .sidebar {
            width: 380px;
            /* Un poco m√°s ancho para mejor lectura */
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .campaign-selector {
            width: 100%;
            padding: 0.6rem;
            background: #1f2937;
            color: white;
            border: 1px solid var(--border);
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        .script-list {
            padding: 1rem;
            flex-grow: 1;
            overflow-y: auto;
        }

        .script-card {
            background: #1f2937;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 1.25rem;
            margin-bottom: 1rem;
            transition: border-color 0.2s;
        }

        .script-card:hover {
            border-color: var(--primary);
        }

        .script-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .script-title {
            font-weight: 700;
            font-size: 1rem;
            color: #e5e7eb;
        }

        .script-content {
            font-size: 1rem;
            /* AUMENTADO */
            line-height: 1.6;
            color: #d1d5db;
            /* Texto m√°s claro */
            white-space: pre-wrap;
            max-height: 100px;
            overflow: hidden;
            cursor: pointer;
            position: relative;
            padding-bottom: 1rem;
            /* Espacio para el indicador */
        }

        .script-content.expanded {
            max-height: none;
        }

        .script-content::after {
            content: '‚¨áÔ∏è ver m√°s';
            font-size: 0.8rem;
            color: var(--primary);
            position: absolute;
            bottom: 0;
            right: 0;
            background: #1f2937;
            padding-left: 10px;
            cursor: pointer;
        }

        .script-content.expanded::after {
            display: none;
        }

        .script-actions {
            display: flex;
            gap: 0.5rem;
        }

        .icon-btn {
            background: transparent;
            border: 1px solid #374151;
            color: #9ca3af;
            cursor: pointer;
            padding: 6px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .icon-btn:hover {
            background: #374151;
            color: white;
            border-color: #4b5563;
        }

        .icon-btn.edit:hover {
            color: var(--warning);
            border-color: var(--warning);
        }

        .icon-btn.delete:hover {
            color: var(--danger);
            border-color: var(--danger);
        }

        .icon-btn.copy:hover {
            color: var(--success);
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }

        /* MAIN CONTENT */
        .main-content {
            flex-grow: 1;
            padding: 2rem;
            overflow-y: auto;
            position: relative;
        }

        /* HEADER y GRID */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 0.375rem;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
        }

        .btn-sm {
            font-size: 0.85rem;
            padding: 0.4rem 0.8rem;
        }

        .table-container {
            background: #111827;
            border: 1px solid #1f2937;
            border-radius: 0.75rem;
            overflow: hidden;
            margin-top: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
            color: #f3f4f6;
        }

        .data-table thead {
            background: #1f2937;
            border-bottom: 2px solid #374151;
        }

        .data-table th {
            padding: 0.875rem 1rem;
            text-align: left;
            font-weight: 600;
            color: #9ca3af;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.025em;
        }

        .data-table tbody tr {
            border-bottom: 1px solid #1f2937;
            transition: background 0.2s;
        }

        .data-table tbody tr:hover {
            background: #1e293b;
        }

        .data-table td {
            padding: 0.75rem 1rem;
            vertical-align: middle;
        }

        .data-table .status-badge {
            display: inline-block;
            padding: 0.125rem 0.625rem;
            border-radius: 9999px;
            font-weight: 500;
        }

        /* BULK ACTIONS BAR */
        #bulkActionBar {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(150px);
            background: #1f2937;
            padding: 0.75rem 1.5rem;
            border-radius: 1rem;
            display: flex;
            align-items: center;
            gap: 1.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.7);
            border: 1px solid var(--primary);
            z-index: 3000;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        #bulkActionBar.active {
            transform: translateX(-50%) translateY(0);
        }

        .bulk-count {
            background: var(--primary);
            color: black;
            padding: 0.2rem 0.6rem;
            border-radius: 0.5rem;
            font-weight: bold;
            font-size: 0.9rem;
        }

        input[type="checkbox"].row-selector {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--primary);
            margin: 0;
        }

        .card {
            background: var(--card-bg);
            border-radius: 0.5rem;
            padding: 1.5rem;
            border: 1px solid var(--border);
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-pending {
            background: #334155;
        }

        .status-contacted {
            background: var(--warning);
            color: #000;
        }

        .status-negotiating {
            background: var(--primary);
        }

        .status-closed {
            background: var(--success);
        }

        /* MODALS */
        /* MINI STATS CARDS */
        .mini-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .mini-stat-card {
            background: #111827;
            border: 1px solid #1f2937;
            padding: 1rem;
            border-radius: 0.75rem;
            display: flex;
            flex-direction: column;
        }

        .mini-stat-card .label {
            font-size: 0.75rem;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .mini-stat-card .value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
        }

        /* ADVANCED FILTERS */
        .filters-panel {
            background: #111827;
            padding: 1rem;
            border-radius: 0.75rem;
            border: 1px solid #1f2937;
            margin-bottom: 1rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            align-items: flex-end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .filter-group label {
            font-size: 0.7rem;
            color: #6b7280;
            margin: 0;
        }

        .filter-group input,
        .filter-group select {
            margin: 0;
            padding: 0.5rem;
            font-size: 0.85rem;
            min-width: 140px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 0.5rem;
            width: 100%;
            max-width: 600px;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 0.75rem;
            background: #0f172a;
            border: 1px solid var(--border);
            color: white;
            border-radius: 0.375rem;
            margin-bottom: 1.25rem;
            font-family: inherit;
            font-size: 0.95rem;
            /* Input text bigger */
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            font-weight: 600;
            color: #cbd5e1;
        }
    </style>
</head>

<body>
    <!-- MOBILE TOGGLE -->
    <button id="mobileScriptToggle" onclick="document.querySelector('.sidebar').classList.toggle('active')">
        üí¨ Ver Scripts / Campa√±as
    </button>

    <!-- SIDEBAR: CAMPA√ëAS Y SCRIPTS -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h3 style="margin:0 0 1rem 0;">üí¨ Gestor de Scripts</h3>
            <label style="font-size:0.85rem; color:#9ca3af; margin-bottom:0.5rem;">Seleccionar Campa√±a:</label>
            <div style="display:flex; gap:0.5rem; flex-direction: column;">
                <select id="campaignSelect" class="campaign-selector" onchange="loadScripts(this.value)">
                    <option value="">Cargando...</option>
                </select>

                <!-- Mission Card (Target Info) -->
                <div id="missionCard"
                    style="display:none; background:#1e293b; padding:0.75rem; border-radius:0.5rem; border-left:3px solid var(--primary); margin-bottom:1rem; font-size:0.85rem;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:0.25rem;">
                        <span id="mcPlatform" style="font-weight:bold;">üì± -</span>
                        <span id="mcGeo">üåç -</span>
                    </div>
                    <div style="display:flex; justify-content:space-between;">
                        <span id="mcFollowers">üë• -</span>
                        <span id="mcBudget" style="color:var(--success);">üí∞ -</span>
                    </div>
                    <div id="mcNiche"
                        style="margin-top:0.4rem; padding-top:0.4rem; border-top:1px solid #374151; color:#94a3b8; font-style:italic;">
                        üéØ -
                    </div>
                </div>

                <!-- Solo Admin -->
                <div id="adminScriptControls" style="display:none; gap: 0.5rem;">
                    <button id="addCampaignBtn" class="btn btn-sm btn-outline"
                        onclick="openModal('createCampaignModal')" style="flex:1;">+ Nueva Campa√±a</button>
                    <button id="addScriptBtn" class="btn btn-sm" onclick="openScriptModal('create')" style="flex:1;">+
                        Nuevo Mensaje</button>
                </div>
            </div>
        </div>

        <div id="scriptList" class="script-list">
            <div style="text-align:center; color:#6b7280; padding-top:2rem;">Selecciona una campa√±a</div>
        </div>
    </div>

    <!-- CONTENIDO PRINCIPAL -->
    <div class="main-content">
        <div class="container" style="max-width: 1200px; margin: 0 auto;">
            <header>
                <div>
                    <h1>Winton CRM</h1>
                    <p id="userWelcome" style="color: #94a3b8; margin-top: 0.5rem;">Agente</p>
                </div>
                <div style="display:flex; gap:1rem; align-items: center;">
                    <button class="btn btn-outline" onclick="openModal('bulkImportModal')">üìã Importar Excel</button>
                    <button class="btn" onclick="openCreateLeadModal()">+ Nuevo Lead</button>
                    <!-- Admin Only Buttons -->
                    <div id="adminButtons" style="display:none; gap:0.5rem;">
                        <button class="btn btn-outline" onclick="openReportModal()">üìä Reportes</button>
                        <button class="btn btn-outline" onclick="openTeamModal()">üë• Equipo</button>
                    </div>
                    <button class="btn btn-outline" id="logoutBtn" style="border:none; color: #ef4444;">Salir</button>
                </div>
            </header>

            <!-- ... (leads grid etc) ... -->
            <!-- Modal Reportes (Supervisi√≥n) -->
            <div id="reportsModal" class="modal">
                <div class="modal-content" style="max-width: 900px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
                        <h3>üìä Panel de Supervisi√≥n</h3>
                        <button class="btn btn-sm btn-outline" onclick="closeModal('reportsModal')">Cerrar</button>
                    </div>

                    <!-- KPIs -->
                    <div class="grid" style="grid-template-columns: repeat(3, 1fr); gap:1rem; margin-bottom:2rem;">
                        <div class="card" style="text-align:center; padding:1rem;">
                            <h4 style="margin:0; color:#9ca3af;">Total Leads</h4>
                            <span id="kpiTotal" style="font-size:2rem; font-weight:bold;">-</span>
                        </div>
                        <div class="card" style="text-align:center; padding:1rem;">
                            <h4 style="margin:0; color:#9ca3af;">Actividad Hoy</h4>
                            <span id="kpiToday" style="font-size:2rem; font-weight:bold; color:var(--primary);">-</span>
                        </div>
                        <div class="card" style="text-align:center; padding:1rem;">
                            <h4 style="margin:0; color:#9ca3af;">Deals Cerrados</h4>
                            <span id="kpiClosed"
                                style="font-size:2rem; font-weight:bold; color:var(--success);">-</span>
                        </div>
                    </div>

                    <!-- Tabla Leaderboard -->
                    <h4 style="margin-bottom:0.5rem;">üèÜ Rendimiento por Agente</h4>
                    <div
                        style="overflow-x:auto; max-height:200px; border:1px solid var(--border); border-radius:0.5rem; margin-bottom: 2rem;">
                        <table style="width:100%; border-collapse:collapse; font-size:0.9rem;">
                            <thead style="background:#1f2937; position:sticky; top:0;">
                                <tr>
                                    <th style="padding:0.75rem; text-align:left;">Agente</th>
                                    <th style="padding:0.75rem; text-align:center;">Leads Asignados</th>
                                    <th style="padding:0.75rem; text-align:center;">Deals Cerrados</th>
                                    <th style="padding:0.75rem; text-align:right;">√öltima Actividad</th>
                                </tr>
                            </thead>
                            <tbody id="leaderboardBody">
                                <tr>
                                    <td colspan="4" style="text-align:center; padding:1rem;">Cargando...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Tabla Actividad Reciente -->
                    <h4>Actividad Reciente (Feed en Vivo)</h4>
                    <div
                        style="overflow-x:auto; max-height:400px; border:1px solid var(--border); border-radius:0.5rem;">
                        <table style="width:100%; border-collapse:collapse; font-size:0.9rem;">
                            <thead style="background:#1f2937; position:sticky; top:0;">
                                <tr>
                                    <th style="padding:0.75rem; text-align:left;">Hora</th>
                                    <th style="padding:0.75rem; text-align:left;">Agente</th>
                                    <th style="padding:0.75rem; text-align:left;">Influencer</th>
                                    <th style="padding:0.75rem; text-align:left;">Acci√≥n</th>
                                    <th style="padding:0.75rem; text-align:left;">Notas</th>
                                </tr>
                            </thead>
                            <tbody id="activityTableBody">
                                <tr>
                                    <td colspan="5" style="padding:1rem; text-align:center;">Cargando...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- VISTA ADMIN: TABLERO DE COMANDO -->
            <div id="adminDashboardView" style="display:none; margin-top:2rem;">
                <h2 style="border-bottom:1px solid #374151; padding-bottom:0.5rem; margin-bottom:1.5rem;">üëÆ‚Äç‚ôÇÔ∏è
                    Supervisi√≥n de Agentes</h2>

                <div id="agentsGrid" class="grid"
                    style="grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:1.5rem;">
                    <div style="text-align:center; padding:2rem; color:#94a3b8;">Cargando equipo...</div>
                </div>
            </div>

            <!-- VISTA AGENTE: MIS LEADS -->
            <div id="agentDashboardView" style="display:none;">
                <!-- AGENT MINI KPI SECTION -->
                <div id="agentMiniStats" class="mini-stats-grid" style="margin-top:2rem;">
                    <div class="mini-stat-card">
                        <span class="label">Total Prospectos</span>
                        <span class="value" id="statLeadsTotal">0</span>
                    </div>
                    <div class="mini-stat-card">
                        <span class="label">Contactados</span>
                        <span class="value" id="statLeadsContacted" style="color:var(--warning);">0</span>
                    </div>
                    <div class="mini-stat-card">
                        <span class="label">Conversi√≥n</span>
                        <span class="value" id="statLeadsConv" style="color:var(--success);">0%</span>
                    </div>
                    <div class="mini-stat-card">
                        <span class="label">Nuevos Hoy</span>
                        <span class="value" id="statLeadsToday" style="color:var(--primary);">0</span>
                    </div>
                </div>

                <!-- Filtros Avanzados -->
                <div class="filters-panel">
                    <div class="filter-group" style="flex:1; min-width:200px;">
                        <label>Buscar Handle/Nombre</label>
                        <input type="text" id="searchFilter" placeholder="Ej: @usuario..." oninput="filterLeadsLocal()">
                    </div>
                    <div class="filter-group">
                        <label>Estado</label>
                        <select id="statusFilter" onchange="filterLeadsLocal()">
                            <option value="all">Todos los Estados</option>
                            <option value="pending">Pendientes</option>
                            <option value="contacted">Contactados</option>
                            <option value="negotiating">Negociando</option>
                            <option value="closed">Cerrados</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Nicho</label>
                        <select id="nicheFilter" onchange="filterLeadsLocal()">
                            <option value="all">Todos los Nichos</option>
                            <option value="Crypto">Crypto</option>
                            <option value="Finanzas">Finanzas</option>
                            <option value="Humor">Humor</option>
                            <option value="Lifestyle">Lifestyle</option>
                            <option value="Tech">Tech</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Seguidores (M√≠n)</label>
                        <input type="number" id="followersMinFilter" placeholder="0" oninput="filterLeadsLocal()">
                    </div>
                    <button class="btn btn-sm btn-outline" style="height:38px; padding:0 1rem;"
                        onclick="resetAllFilters()">Limpiar</button>
                </div>

                <div id="leadsTableContainer" class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th style="width: 40px; text-align: center;">
                                    <input type="checkbox" id="selectAllLeads" class="row-selector"
                                        onclick="toggleAllLeads(this)">
                                </th>
                                <th>Prospecto</th>
                                <th>M√©tricas</th>
                                <th>Nicho / Pa√≠s</th>
                                <th>√öltima Nota</th>
                                <th style="text-align:center;">Estado</th>
                                <th style="text-align:center;">Engagement</th>
                                <th style="text-align:right;">Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody id="leadsTableBody"></tbody>
                    </table>
                </div>

                <!-- Floating Bulk Actions Bar -->
                <div id="bulkActionBar">
                    <div
                        style="display:flex; align-items:center; gap:0.5rem; border-right:1px solid #374151; padding-right:1rem;">
                        <span class="bulk-count" id="selectedCount">0</span>
                        <span style="font-size:0.9rem; color:#9ca3af;">Seleccionados</span>
                    </div>
                    <div style="display:flex; gap:0.75rem;">
                        <button class="btn btn-sm btn-outline" onclick="exportToCSV()" title="Exportar a Excel/CSV">
                            <i class="ph ph-download"></i> Exportar
                        </button>
                        <button class="btn btn-sm btn-outline" onclick="bulkEditStatus()" title="Cambiar Estado">
                            <i class="ph ph-arrow-clockwise"></i> Estado
                        </button>
                        <button class="btn btn-sm btn-outline"
                            style="color:#ef4444; border-color:rgba(239, 68, 68, 0.3);" onclick="bulkDeleteLeads()">
                            <i class="ph ph-trash"></i> Borrar
                        </button>
                    </div>
                    <button class="btn btn-sm" onclick="clearSelection()"
                        style="background:transparent; border:none; color:#9ca3af;">Cancelar</button>
                </div>
            </div>

            <!-- VISTA FULL PRO AGENTE (SUPERVISI√ìN DETALLADA) -->
            <div id="agentFullProfileView" style="display:none; height: calc(100vh - 100px); overflow:hidden;">
                <!-- HEADER & NAV -->
                <div
                    style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem; padding-bottom:1rem; border-bottom:1px solid #374151;">
                    <div style="display:flex; align-items:center; gap:1rem;">
                        <button class="btn btn-outline" onclick="initDashboard()">‚Üê Volver</button>
                        <div
                            style="width:40px; height:40px; background:#374151; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:1.2rem;">
                            üë§</div>
                        <div>
                            <h2 style="margin:0; font-size:1.5rem;" id="fpAgentName">Agente</h2>
                            <div style="font-size:0.85rem; color:#9ca3af;">ID: <span id="fpAgentId">-</span> ‚Ä¢ Miembro
                                desde: <span id="fpAgentJoined">-</span></div>
                        </div>
                    </div>
                    <div style="display:flex; gap:2rem; text-align:right;">
                        <div>
                            <span
                                style="display:block; font-size:0.75rem; color:#9ca3af; text-transform:uppercase;">Total
                                Leads</span>
                            <span style="font-size:1.5rem; font-weight:bold;" id="fpStatTotal">-</span>
                        </div>
                        <div>
                            <span
                                style="display:block; font-size:0.75rem; color:#9ca3af; text-transform:uppercase;">Contactados</span>
                            <span style="font-size:1.5rem; font-weight:bold; color:var(--primary);"
                                id="fpStatContacted">-</span>
                        </div>
                        <div>
                            <span
                                style="display:block; font-size:0.75rem; color:#9ca3af; text-transform:uppercase;">Cerrados</span>
                            <span style="font-size:1.5rem; font-weight:bold; color:var(--success);"
                                id="fpStatClosed">-</span>
                        </div>
                        <div>
                            <span
                                style="display:block; font-size:0.75rem; color:#9ca3af; text-transform:uppercase;">Conversi√≥n</span>
                            <span style="font-size:1.5rem; font-weight:bold; color:#facc15;"
                                id="fpStatConversion">0%</span>
                        </div>
                    </div>
                </div>

                <!-- CONTENIDO PRINCIPAL (SPLIT VIEW) -->
                <div style="display:grid; grid-template-columns: 2fr 1fr; gap:1.5rem; height: calc(100% - 140px);">

                    <!-- IZQUIERDA: CARTERA DE CLIENTES -->
                    <div class="card"
                        style="display:flex; flex-direction:column; padding:0; overflow:hidden; border:1px solid #374151;">
                        <div
                            style="padding:1rem; background:#1f2937; border-bottom:1px solid #374151; display:flex; justify-content:space-between; align-items:center;">
                            <h3 style="margin:0; font-size:1.1rem;">üìÇ Cartera Asignada</h3>
                            <input type="text" placeholder="Buscar lead..."
                                style="padding:0.4rem; font-size:0.8rem; border-radius:4px; border:1px solid #4b5563; background:#374151; color:white;"
                                onkeyup="filterAgentLeads(this.value)">
                        </div>

                        <div style="overflow-y:auto; flex:1;">
                            <table style="width:100%; border-collapse:collapse; font-size:0.9rem;">
                                <thead style="background:#111827; position:sticky; top:0; z-index:10;">
                                    <tr>
                                        <th style="padding:0.75rem; text-align:left; color:#9ca3af;">Nombre</th>
                                        <th style="padding:0.75rem; text-align:left; color:#9ca3af;">Plataforma/Pa√≠s
                                        </th>
                                        <th style="padding:0.75rem; text-align:center; color:#9ca3af;">Nicho</th>
                                        <th style="padding:0.75rem; text-align:center; color:#9ca3af;">Estado</th>
                                        <th style="padding:0.75rem; text-align:right; color:#9ca3af;">Acci√≥n</th>
                                    </tr>
                                </thead>
                                <tbody id="fpLeadsBody">
                                    <!-- JS Inject -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- DERECHA: INSPECTOR DE ACTIVIDAD -->
                    <div class="card"
                        style="display:flex; flex-direction:column; padding:0; overflow:hidden; border:1px solid #374151; background:#0f172a;">
                        <div style="padding:1rem; background:#1e293b; border-bottom:1px solid #374151;">
                            <h3 style="margin:0; font-size:1.1rem; color:var(--primary);" id="fpInspectorTitle">üì° Feed
                                Global</h3>
                            <div style="font-size:0.75rem; color:#9ca3af; margin-top:0.25rem;">Haga clic en un lead para
                                ver su historial espec√≠fico</div>
                        </div>
                        <div id="fpInspectorContent"
                            style="overflow-y:auto; flex:1; padding:1rem; display:flex; flex-direction:column; gap:1rem;">
                            <!-- JS Inject Timeline -->
                        </div>
                    </div>

                </div>
            </div>


            <!-- ================= MODALS ================= -->

            <!-- Modal Crear Campa√±a -->
            <div id="createCampaignModal" class="modal">
                <div class="modal-content">
                    <h3>Nueva Campa√±a</h3>
                    <form id="createCampaignForm">
                        <label>Nombre de la Campa√±a</label>
                        <input type="text" id="newCampName" required placeholder="Ej: Febrero 2026 - TikTok">
                        <label>Descripci√≥n (Objetivo General)</label>
                        <textarea id="newCampDesc" rows="2"></textarea>

                        <h4 style="margin: 1rem 0 0.5rem; color: var(--primary); border-bottom: 1px solid #374151;">üéØ
                            Misi√≥n / Target</h4>

                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:0.75rem;">
                            <div>
                                <label>Plataforma(s)</label>
                                <input type="text" id="targetPlatform" placeholder="Ej: TikTok, Instagram">
                            </div>
                            <div>
                                <label>Ubicaci√≥n (GEO)</label>
                                <input type="text" id="targetGeo" placeholder="Ej: Espa√±a, LATAM">
                            </div>
                            <div>
                                <label>Rango Seguidores</label>
                                <input type="text" id="targetFollowers" placeholder="Ej: 10k - 50k">
                            </div>
                            <div>
                                <label>Presupuesto (USD)</label>
                                <input type="text" id="targetBudget" placeholder="Ej: $50 - $150">
                            </div>
                        </div>
                        <label>Nicho / Vertical</label>
                        <input type="text" id="targetNiche" placeholder="Ej: Cripto, Finanzas, Lifestyle">

                        <div
                            style="margin: 1rem 0; display: flex; align-items: center; gap: 0.5rem; background: #1f2937; padding: 0.75rem; border-radius: 0.5rem; border: 1px dashed var(--primary);">
                            <input type="checkbox" id="requireAllFields" style="width: auto; margin: 0;">
                            <label for="requireAllFields"
                                style="margin: 0; font-weight: bold; color: var(--primary); cursor: pointer;">
                                ‚ö†Ô∏è Obligar al agente a llenar TODOS los campos del Lead
                            </label>
                        </div>
                        <div style="text-align:right;">
                            <button type="button" class="btn btn-outline"
                                onclick="closeModal('createCampaignModal')">Cancelar</button>
                            <button type="submit" class="btn">Crear</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Modal Crear/Editar Script -->
            <div id="scriptModal" class="modal">
                <div class="modal-content">
                    <h3 id="scriptModalTitle">Nuevo Mensaje</h3>
                    <form id="scriptForm">
                        <input type="hidden" id="scriptId"> <!-- Para edici√≥n -->
                        <label>T√≠tulo (Ej: Primer Contacto)</label>
                        <input type="text" id="scriptTitle" required>
                        <label>Contenido del Mensaje</label>
                        <textarea id="scriptContent" rows="8" required style="font-size: 1rem;"></textarea>
                        <div style="text-align:right;">
                            <button type="button" class="btn btn-outline"
                                onclick="closeModal('scriptModal')">Cancelar</button>
                            <button type="submit" class="btn">Guardar</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Modal Crear/Editar Lead -->
            <div id="createLeadModal" class="modal">
                <div class="modal-content">
                    <h3 id="leadModalTitle">Nuevo Prospecto</h3>
                    <form id="createLeadForm">
                        <input type="hidden" id="editLeadId">
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:1rem;">
                            <div>
                                <label>Nombre / Handle</label> <input type="text" id="newLeadName" required
                                    placeholder="@usuario">
                                <label>Plataforma</label>
                                <select id="newLeadPlatform">
                                    <option value="Instagram">Instagram</option>
                                    <option value="TikTok">TikTok</option>
                                    <option value="YouTube">YouTube</option>
                                </select>
                                <label>Seguidores</label> <input type="number" id="newLeadFollowers" required
                                    placeholder="Ej: 15000">
                                <label>Promedio Views (√ölt. 5 videos)</label> <input type="number" id="newLeadViews"
                                    required placeholder="Ej: 3000">
                            </div>
                            <div>
                                <label>Email (Obligatorio)</label> <input type="email" id="newLeadEmail" required
                                    placeholder="contacto@...">
                                <label>Pa√≠s</label> <input type="text" id="newLeadCountry" required
                                    placeholder="Ej: Argentina">
                                <label>Nicho</label>
                                <select id="newLeadNiche">
                                    <option value="Crypto">Crypto</option>
                                    <option value="Finanzas">Finanzas</option>
                                    <option value="Humor">Humor</option>
                                    <option value="Lifestyle">Lifestyle</option>
                                    <option value="Tech">Tecnolog√≠a</option>
                                    <option value="Pol√≠tica">Pol√≠tica</option>
                                    <option value="Salud">Salud</option>
                                    <option value="Familia">Familia</option>
                                    <option value="Mascotas">Mascotas</option>
                                    <option value="Otro">Otro</option>
                                </select>
                                <label>Link Perfil</label> <input type="url" id="newLeadUrl" required
                                    placeholder="https://...">
                            </div>
                        </div>
                        <div id="mandatoryAlert"
                            style="display:none; margin-top:1rem; padding:0.5rem; background:rgba(239, 68, 68, 0.1); border:1px solid #ef4444; border-radius:4px; color:#f87171; font-size:0.8rem; text-align:center;">
                            ‚ö†Ô∏è El administrador requiere que completes todos los campos para esta campa√±a.
                        </div>
                        <div style="text-align:right; margin-top:1rem;">
                            <button type="button" class="btn btn-outline"
                                onclick="closeModal('createLeadModal')">Cancelar</button>
                            <button type="submit" class="btn">Guardar</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Modal Registrar Acci√≥n -->
            <div id="actionModal" class="modal">
                <div class="modal-content">
                    <h3>Registrar Avance</h3>
                    <p id="actionLeadName" style="color:#9ca3af; margin-bottom:1rem;"></p>
                    <form id="actionForm">
                        <input type="hidden" id="actionLeadId">
                        <label>Acci√≥n</label>
                        <select id="actionType">
                            <option value="initial_message">1. Primer Contacto</option>
                            <option value="response_received">2. Respuesta Recibida</option>
                            <option value="budget_received">3. Presupuesto Recibido</option>
                            <option value="deal_closed">4. Cierre</option>
                        </select>
                        <label>Nuevo Estado</label>
                        <select id="actionNewStatus">
                            <option value="contacted">Contactado</option>
                            <option value="negotiating">Negociando</option>
                            <option value="closed">Cerrado</option>
                        </select>
                        <label>Presupuesto Acordado ($)</label>
                        <input type="number" id="actionBudget" placeholder="Ej: 500 (Opcional)">
                        <label>Notas</label> <textarea id="actionNotes" rows="2"></textarea>
                        <label>Screenshot URL</label> <input type="text" id="actionScreenshotUrl">
                        <div style="text-align:right;">
                            <button type="button" class="btn btn-outline"
                                onclick="closeModal('actionModal')">Cancelar</button>
                            <button type="submit" class="btn">Registrar</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Admin Modals -->
            <div id="createAgentModal" class="modal">
                <div class="modal-content">
                    <h3>Nuevo Agente</h3>
                    <form id="createAgentForm"><label>Usuario</label><input id="agUser"
                            placeholder="Usuario"><label>Contrase√±a</label><input id="agPass" type="password"
                            placeholder="Pass">
                        <div style="text-align:right;"><button type="button" class="btn btn-outline"
                                onclick="closeModal('createAgentModal')">Cancelar</button> <button
                                class="btn">Crear</button>
                        </div>
                    </form>
                </div>
            </div>
            <div id="assignAgentModal" class="modal">
                <div class="modal-content">
                    <h3>Asignar</h3>
                    <form id="assignAgentForm"><label>Lead</label><select
                            id="asLead"></select><label>Agente</label><select id="asAgent"></select>
                        <div style="text-align:right;"><button type="button" class="btn btn-outline"
                                onclick="closeModal('assignAgentModal')">Cancelar</button> <button
                                class="btn">Asignar</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Modal Detalle Agente (Auditor√≠a) -->
            <div id="agentDetailModal" class="modal" style="display:none; z-index: 2200; background: rgba(0,0,0,0.95);">
                <div class="modal-content" style="max-width: 900px; height: 90vh;">
                    <div
                        style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #374151; padding-bottom:1rem; margin-bottom:1rem;">
                        <h3 id="auditAgentTitle" style="margin:0;">Auditor√≠a</h3>
                        <button class="btn btn-sm btn-outline" onclick="closeModal('agentDetailModal')">Cerrar</button>
                    </div>

                    <div class="grid" style="grid-template-columns: 1fr 1fr; gap:2rem; height: calc(100% - 60px);">
                        <!-- LEADS -->
                        <div style="display:flex; flex-direction:column; overflow:hidden;">
                            <h4
                                style="color:var(--primary); margin-top:0; border-bottom:1px solid #374151; padding-bottom:0.5rem;">
                                üìÇ Leads Asignados</h4>
                            <div id="auditLeadsList" style="overflow-y:auto; flex-grow:1; padding-right:0.5rem;"></div>
                        </div>

                        <!-- HISTORIAL -->
                        <div
                            style="display:flex; flex-direction:column; overflow:hidden; border-left:1px solid #374151; padding-left:1rem;">
                            <h4
                                style="color:var(--warning); margin-top:0; border-bottom:1px solid #374151; padding-bottom:0.5rem;">
                                üïí Historial de Acciones</h4>
                            <div id="auditHistoryList" style="overflow-y:auto; flex-grow:1; padding-right:0.5rem;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Gesti√≥n de Equipo -->
            <div id="teamModal" class="modal" style="display:none; z-index: 2000;">
                <div class="modal-content" style="max-width: 800px;">
                    <div
                        style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem; border-bottom:1px solid #374151; padding-bottom:1rem;">
                        <h3 style="margin:0;">üë• Gesti√≥n de Equipo</h3>
                        <button class="btn btn-sm btn-outline" onclick="closeModal('teamModal')">Cerrar</button>
                    </div>

                    <div style="display:flex; gap:1rem; margin-bottom:1.5rem;">
                        <button class="btn btn-sm" onclick="openModal('createAgentModal')">+ Nuevo Agente</button>
                        <button class="btn btn-sm btn-outline" onclick="openModal('assignAgentModal')">Asignar
                            Leads</button>
                    </div>

                    <table style="width:100%; border-collapse:collapse;">
                        <thead style="background:#1f2937; color:#9ca3af;">
                            <tr>
                                <th style="padding:0.75rem; text-align:left;">Usuario</th>
                                <th style="padding:0.75rem; text-align:left;">Rol</th>
                                <th style="padding:0.75rem; text-align:left;">Fecha Alta</th>
                                <th style="padding:0.75rem; text-align:right;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="teamListBody">
                            <tr>
                                <td colspan="4" style="text-align:center; padding:1rem;">Cargando...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Modal Bulk Import (Expert Mode) -->
            <div id="bulkImportModal" class="modal">
                <div class="modal-content"
                    style="max-width: 1000px; height: 85vh; display:flex; flex-direction:column;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                        <h3>üìã Importaci√≥n Inteligente (Excel/Google Sheets)</h3>
                        <button class="btn btn-sm btn-outline" onclick="closeModal('bulkImportModal')">Cerrar</button>
                    </div>

                    <div
                        style="background:#111827; padding:1.25rem; border-radius:1rem; border:1px solid #1f2937; margin-bottom:1.5rem;">
                        <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:1.5rem;">
                            <div style="flex:1;">
                                <h4 style="margin:0 0 0.5rem 0; color:white; font-size:1rem;">ü§ñ Estrategia de
                                    Prospecci√≥n IA</h4>
                                <p style="margin:0; color:#9ca3af; font-size:0.85rem; line-height:1.5;">
                                    Usa una IA para buscar leads y p√≠dele que use este formato de columnas exacto. Copia
                                    el prompt de abajo para empezar.
                                </p>
                            </div>
                            <button class="btn btn-sm btn-outline" onclick="copyAIPrompt()"
                                style="white-space:nowrap; background:rgba(59, 130, 246, 0.1); border-color:rgba(59, 130, 246, 0.3); color:#60a5fa;">
                                <i class="ph ph-magic-wand"></i> Copiar Prompt para IA
                            </button>
                        </div>

                        <div
                            style="margin-top:1.25rem; padding:0.75rem; background:#0f172a; border-radius:0.5rem; border:1px solid #334155;">
                            <div
                                style="display:grid; grid-template-columns: repeat(8, 1fr); gap:4px; text-align:center; font-size:0.65rem; color:#94a3b8; font-weight:bold; text-transform:uppercase;">
                                <div
                                    style="padding:4px; background:#1e293b; border-radius:4px 0 0 4px; color:var(--primary);">
                                    Nombre</div>
                                <div style="padding:4px; background:#1e293b;">Plataforma</div>
                                <div style="padding:4px; background:#1e293b; color:var(--primary);">Link Perfil</div>
                                <div style="padding:4px; background:#1e293b;">Seguidores</div>
                                <div style="padding:4px; background:#1e293b;">Views</div>
                                <div style="padding:4px; background:#1e293b;">Pa√≠s</div>
                                <div style="padding:4px; background:#1e293b;">Nicho</div>
                                <div style="padding:4px; background:#1e293b; border-radius:0 4px 4px 0;">Email</div>
                            </div>
                        </div>
                    </div>

                    <div id="pasteStep">
                        <textarea id="bulkPasteArea" placeholder="Pega aqu√≠ tus datos de Excel..."
                            style="width:100%; height:150px; background:#0f172a; color:#f8fafc; font-family:monospace; padding:1rem; border:2px dashed #334155; border-radius:0.5rem; resize:none;"></textarea>
                        <div style="text-align:right; margin-top:1rem;">
                            <button class="btn" onclick="validateImportBatch()">üîç Validar Datos</button>
                        </div>
                    </div>

                    <div id="validationStep" style="display:none; flex:1; overflow:hidden; flex-direction:column;">
                        <h4 style="margin-bottom:0.5rem;">üîç Pre-visualizaci√≥n y Validaci√≥n</h4>
                        <div
                            style="flex:1; overflow-y:auto; border:1px solid #334155; border-radius:0.5rem; background:#0f172a;">
                            <table style="width:100%; border-collapse:collapse; font-size:0.85rem;">
                                <thead style="background:#1e293b; position:sticky; top:0;">
                                    <tr>
                                        <th style="padding:0.5rem; text-align:left;">Handle</th>
                                        <th style="padding:0.5rem; text-align:left;">Estado</th>
                                        <th style="padding:0.5rem; text-align:left;">Detalle / Conflicto</th>
                                    </tr>
                                </thead>
                                <tbody id="bulkValidationTableBody"></tbody>
                            </table>
                        </div>
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:1rem;">
                            <button class="btn btn-outline" onclick="resetBulkImport()">‚Üê Empezar de nuevo</button>
                            <button class="btn" id="confirmBulkBtn" onclick="confirmBulkImport()">‚úÖ Importar <span
                                    id="safeCount">0</span> Prospectos</button>
                        </div>
                    </div>
                </div>
            </div>

            <script src="config.js"></script>
            <script>
                const API_URL = CONFIG.API_URL;
                let user = JSON.parse(localStorage.getItem('crm_user') || '{}');
                const token = localStorage.getItem('crm_token');
                let currentCampaignId = null;

                if (!token) window.location.href = 'index.html';

                // Inicializaci√≥n
                document.getElementById('userWelcome').textContent = `${user.username} (${user.role})`;
                if (user.role === 'admin') {
                    document.getElementById('adminScriptControls').style.display = 'flex';
                    document.getElementById('adminButtons').style.display = 'flex';
                }

                // ================= CAMPA√ëAS Y SCRIPTS =================
                let campaignsCache = []; // Cache para info de target

                async function loadCampaigns() {
                    try {
                        const res = await fetch(`${API_URL}/campaigns`, { headers: { 'Authorization': `Bearer ${token}` } });
                        const campaigns = await res.json();
                        campaignsCache = campaigns;

                        const select = document.getElementById('campaignSelect');
                        select.innerHTML = '';

                        if (campaigns.length > 0) {
                            campaigns.forEach(c => {
                                const opt = document.createElement('option');
                                opt.value = c.id;
                                opt.textContent = c.name;
                                select.appendChild(opt);
                            });
                            // Cargar scripts de la primera campa√±a por defecto
                            loadScripts(campaigns[0].id);
                        } else {
                            select.innerHTML = '<option>Sin campa√±as</option>';
                            document.getElementById('scriptList').innerHTML = '<div style="text-align:center; padding:1rem; color:#6b7280;">No hay campa√±as activas</div>';
                            document.getElementById('missionCard').style.display = 'none';
                        }
                    } catch (e) { console.error(e); }
                }

                function updateMissionCard(campId) {
                    const campaign = campaignsCache.find(c => c.id == campId);
                    const card = document.getElementById('missionCard');

                    // Al seleccionar campa√±a, configuramos la obligatoriedad de campos en el formulario de prospectos
                    const form = document.getElementById('createLeadForm');
                    const mandatoryAlert = document.getElementById('mandatoryAlert');

                    if (campaign && campaign.require_all_fields) {
                        // Hacer campos obligatorios
                        form.querySelectorAll('input, select').forEach(el => el.required = true);
                        if (mandatoryAlert) mandatoryAlert.style.display = 'block';
                    } else {
                        // Volver a estado normal (solo campos base requeridos)
                        form.querySelectorAll('input, select').forEach(el => el.required = false);
                        document.getElementById('newLeadName').required = true;
                        document.getElementById('newLeadEmail').required = false; // Corregido: Mail opcional por defecto
                        document.getElementById('newLeadUrl').required = true;
                        if (mandatoryAlert) mandatoryAlert.style.display = 'none';
                    }

                    if (!campaign || !campaign.target_config || Object.keys(campaign.target_config).length === 0) {
                        card.style.display = 'none';
                        return;
                    }

                    const t = campaign.target_config;
                    document.getElementById('mcPlatform').textContent = t.platform ? `üì± ${t.platform}` : 'üì± Multi-plataforma';
                    document.getElementById('mcGeo').textContent = t.geo ? `üåç ${t.geo}` : 'üåç Global';
                    document.getElementById('mcFollowers').textContent = t.followers ? `üë• ${t.followers}` : 'üë• Todos';
                    document.getElementById('mcBudget').textContent = t.budget ? `üí∞ ${t.budget}` : 'üí∞ A convenir';

                    const nicheEl = document.getElementById('mcNiche');
                    if (t.niche) {
                        nicheEl.style.display = 'block';
                        nicheEl.textContent = `üéØ ${t.niche}`;
                    } else {
                        nicheEl.style.display = 'none';
                    }
                    card.style.display = 'block';
                }

                async function loadScripts(campId) {
                    currentCampaignId = campId;
                    updateMissionCard(campId);

                    const list = document.getElementById('scriptList');
                    list.innerHTML = '<div style="text-align:center; padding:1rem;">Cargando...</div>';

                    try {
                        const res = await fetch(`${API_URL}/campaigns/${campId}/scripts`, { headers: { 'Authorization': `Bearer ${token}` } });
                        const scripts = await res.json();

                        list.innerHTML = '';
                        if (scripts.length === 0) {
                            list.innerHTML = '<div style="text-align:center; padding:1rem; color:#6b7280;">No hay mensajes en esta campa√±a</div>';
                            return;
                        }

                        scripts.forEach(s => {
                            const isAdmin = user.role === 'admin';
                            const item = document.createElement('div');
                            item.className = 'script-card';

                            // Render HTML
                            item.innerHTML = `
                        <div class="script-header">
                            <span class="script-title">${s.title}</span>
                            <div class="script-actions">
                                <button class="icon-btn copy" title="Copiar"><i class="ph ph-copy"></i></button>
                                ${isAdmin ? `
                                    <button class="icon-btn edit" title="Editar"><i class="ph ph-pencil"></i></button>
                                    <button class="icon-btn delete" title="Borrar"><i class="ph ph-trash"></i></button>
                                ` : ''}
                            </div>
                        </div>
                        <div class="script-content">
                            ${s.content}
                        </div>
                    `;

                            // Add Logic Listeners (Safe method)
                            // Toggle View
                            const contentEl = item.querySelector('.script-content');
                            contentEl.addEventListener('click', () => contentEl.classList.toggle('expanded'));

                            // Copy
                            item.querySelector('.copy').addEventListener('click', (e) => {
                                e.stopPropagation(); // Prevent toggle
                                copyText(s.content);
                            });

                            if (isAdmin) {
                                // Edit
                                item.querySelector('.edit').addEventListener('click', (e) => {
                                    e.stopPropagation();
                                    editScript(s.id, s.title, s.content);
                                });
                                // Delete
                                item.querySelector('.delete').addEventListener('click', (e) => {
                                    e.stopPropagation();
                                    deleteScript(s.id);
                                });
                            }

                            list.appendChild(item);
                        });
                    } catch (e) { console.error(e); }
                }

                // Crear Campa√±a
                document.getElementById('createCampaignForm').addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const name = document.getElementById('newCampName').value;
                    const desc = document.getElementById('newCampDesc').value;
                    const require_all_fields = document.getElementById('requireAllFields').checked;

                    // Capturar par√°metros de audiencia
                    const target_config = {
                        platform: document.getElementById('targetPlatform').value,
                        geo: document.getElementById('targetGeo').value,
                        followers: document.getElementById('targetFollowers').value,
                        budget: document.getElementById('targetBudget').value,
                        niche: document.getElementById('targetNiche').value
                    };

                    try {
                        const res = await fetch(`${API_URL}/campaigns`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                            body: JSON.stringify({ name, description: desc, target_config, require_all_fields })
                        });

                        if (res.ok) {
                            closeModal('createCampaignModal');
                            loadCampaigns();
                            e.target.reset();
                        } else {
                            alert('Error creando campa√±a');
                        }
                    } catch (err) { console.error(err); alert('Error de conexi√≥n'); }
                });

                // Crear/Editar Script
                window.openScriptModal = (mode) => {
                    document.getElementById('scriptModalTitle').textContent = mode === 'create' ? 'Nuevo Mensaje' : 'Editar Mensaje';
                    if (mode === 'create') {
                        document.getElementById('scriptId').value = '';
                        document.getElementById('scriptTitle').value = '';
                        document.getElementById('scriptContent').value = '';
                    }
                    openModal('scriptModal');
                };

                window.editScript = (id, title, content) => {
                    document.getElementById('scriptId').value = id;
                    document.getElementById('scriptTitle').value = title;
                    document.getElementById('scriptContent').value = content;
                    document.getElementById('scriptModalTitle').textContent = 'Editar Mensaje';
                    openModal('scriptModal');
                };

                document.getElementById('scriptForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const id = document.getElementById('scriptId').value;
                    const title = document.getElementById('scriptTitle').value;
                    const content = document.getElementById('scriptContent').value;

                    const method = id ? 'PUT' : 'POST';
                    const url = id
                        ? `${API_URL}/campaigns/scripts/${id}`
                        : `${API_URL}/campaigns/${currentCampaignId}/scripts`;

                    await fetch(url, {
                        method: method,
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({ title, content })
                    });

                    closeModal('scriptModal');
                    loadScripts(currentCampaignId);
                });

                window.deleteScript = async (id) => {
                    if (!confirm('¬øBorrar este mensaje?')) return;
                    await fetch(`${API_URL}/campaigns/scripts/${id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    loadScripts(currentCampaignId);
                };

                // Utilidades
                window.copyText = async (text) => {
                    try {
                        await navigator.clipboard.writeText(text);
                        // Tiny animation or feedback
                        const el = document.activeElement;
                        const original = el.innerHTML;
                        el.innerHTML = '<i class="ph ph-check"></i>';
                        setTimeout(() => el.innerHTML = original, 1000);
                    } catch (err) { alert('Error al copiar'); }
                };

                window.openModal = (id) => document.getElementById(id).style.display = 'flex';
                window.closeModal = (id) => document.getElementById(id).style.display = 'none';

                window.copyAIPrompt = () => {
                    const promptText = `Act√∫a como un experto en Growth Hacking y Prospecci√≥n. Necesito que busques influencers de [INSERTAR NICHO AQU√ç] en [INSERTAR PLATAFORMA/PA√çS AQU√ç]. 
Gen√©rame una tabla lista para copiar y pegar en Excel con estas 8 columnas exactas, manteniendo los encabezados pero asegur√°ndote de que la informaci√≥n sea real y verificada:

1. Handle (Nombre de usuario con @)
2. Plataforma (Instagram, TikTok, etc.)
3. URL Perfil (Link directo al perfil)
4. Seguidores (N√∫mero aproximado)
5. Avg Views (Vistas promedio √∫ltimos videos)
6. Pa√≠s
7. Nicho
8. Email (Si est√° disponible en su bio o similar)

IMPORTANTE: No me des introducciones, solo entr√©game la tabla markdown decorada con los datos reales.`;

                    navigator.clipboard.writeText(promptText).then(() => {
                        alert('¬°Prompt copiado! P√©galo en ChatGPT o Claude para obtener tus leads.');
                    });
                };

                // ================= LEADS (VISTA TABLA PROFESIONAL) =================
                let allLeadsCache = []; // Para filtrado instant√°neo sin peticiones al servidor

                // Formato corto de n√∫meros (K, M) - Utility Global
                const formatLongNum = (n) => {
                    if (!n) return '0';
                    const num = parseInt(n);
                    if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
                    if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
                    return num;
                };

                async function loadLeads() {
                    const tbody = document.getElementById('leadsTableBody');
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:2rem;">Cargando prospectos...</td></tr>';

                    try {
                        const res = await fetch(`${API_URL}/influencers`, { headers: { 'Authorization': `Bearer ${token}` } });
                        allLeadsCache = await res.json();

                        renderLeadsTable(allLeadsCache);
                        updateAgentKPIs(allLeadsCache);
                    } catch (e) {
                        console.error(e);
                        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:2rem; color:#ef4444;">Error cargando datos</td></tr>';
                    }
                }

                function renderLeadsTable(leads) {
                    const tbody = document.getElementById('leadsTableBody');
                    tbody.innerHTML = '';

                    if (leads.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:3rem; color:#6b7280;">No se encontraron prospectos con estos filtros</td></tr>';
                        return;
                    }

                    leads.forEach(l => {
                        const tr = document.createElement('tr');

                        // Formatear √∫ltima nota
                        const noteSnippet = l.last_note
                            ? (l.last_note.length > 50 ? l.last_note.substring(0, 50) + '...' : l.last_note)
                            : '<span style="color:#4b5563; font-style:italic;">Sin interacciones</span>';

                        // Botones de Engagement (Ig, WhatsApp/Mail)
                        const igLink = l.profile_url || `https://instagram.com/${l.name.replace('@', '')}`;
                        const waLink = l.email && l.email.includes('@') ? `mailto:${l.email}` : '#';

                        tr.innerHTML = `
                            <td style="text-align:center;">
                                <input type="checkbox" class="row-selector lead-checkbox" value="${l.id}" onchange="updateSelectionState()">
                            </td>
                            <td>
                                <div style="font-weight:bold; color:white;">${l.name}</div>
                                <div style="font-size:0.7rem; color:#6b7280;">ID: ${l.id}</div>
                            </td>
                            <td>
                                <div style="font-size:0.85rem;"><span style="color:#94a3b8;">Seg:</span> ${formatLongNum(l.followers_count)}</div>
                                <div style="font-size:0.85rem;"><span style="color:#94a3b8;">Views:</span> ${formatLongNum(l.avg_views)}</div>
                                <div style="font-size:0.75rem; color:var(--primary);">${l.platform}</div>
                            </td>
                            <td>
                                <div style="font-size:0.85rem; font-weight:500;">${l.niche || '-'}</div>
                                <div style="font-size:0.75rem; color:#9ca3af;">${l.country || '-'}</div>
                            </td>
                            <td style="max-width:250px;">
                                <div style="font-size:0.8rem; line-height:1.4; color:#d1d5db;">${noteSnippet}</div>
                                ${l.last_interaction_date ? `<div style="font-size:0.65rem; color:#4b5563; margin-top:2px;">${new Date(l.last_interaction_date).toLocaleDateString()}</div>` : ''}
                            </td>
                            <td style="text-align:center;">
                                <span class="status-badge status-${l.status || 'pending'}" style="font-size:0.7rem; padding: 2px 8px;">${(l.status || 'pending').toUpperCase()}</span>
                            </td>
                            <td style="text-align:center;">
                                <div style="display:flex; gap:0.5rem; justify-content:center;">
                                    <a href="${igLink}" target="_blank" class="icon-btn" style="background:rgba(131, 58, 180, 0.2); color:#e1306c; width:32px; height:32px; border-radius:8px;" title="Ver Instagram"><i class="ph ph-instagram-logo"></i></a>
                                    <a href="${waLink}" target="_blank" class="icon-btn" style="background:rgba(16, 185, 129, 0.2); color:#10b981; width:32px; height:32px; border-radius:8px;" title="Enviar Email"><i class="ph ph-envelope-simple"></i></a>
                                </div>
                            </td>
                            <td style="text-align:right;">
                                <div style="display:flex; gap:0.25rem; justify-content:flex-end;">
                                    <button class="btn btn-sm btn-outline" onclick="editLead(${JSON.stringify(l).replace(/"/g, '&quot;')})" style="padding: 0.3rem 0.6rem;">
                                        <i class="ph ph-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm" onclick="openActionModal(${l.id}, '${l.name}')" style="padding: 0.3rem 0.6rem; font-size:0.75rem;">
                                        LOG
                                    </button>
                                </div>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                    updateSelectionState();
                }

                // --- L√ìGICA DE FILTRADO LOCAL (Instant√°neo) ---
                function filterLeadsLocal() {
                    const search = document.getElementById('searchFilter').value.toLowerCase();
                    const status = document.getElementById('statusFilter').value;
                    const niche = document.getElementById('nicheFilter').value;
                    const followersMin = parseInt(document.getElementById('followersMinFilter').value) || 0;

                    const filtered = allLeadsCache.filter(l => {
                        const matchSearch = l.name.toLowerCase().includes(search) || (l.email && l.email.toLowerCase().includes(search));
                        const matchStatus = status === 'all' ? true : l.status === status;
                        const matchNiche = niche === 'all' ? true : l.niche === niche;
                        const matchFollowers = (l.followers_count || 0) >= followersMin;

                        return matchSearch && matchStatus && matchNiche && matchFollowers;
                    });

                    renderLeadsTable(filtered);
                }

                function resetAllFilters() {
                    document.getElementById('searchFilter').value = '';
                    document.getElementById('statusFilter').value = 'all';
                    document.getElementById('nicheFilter').value = 'all';
                    document.getElementById('followersMinFilter').value = '';
                    renderLeadsTable(allLeadsCache);
                }

                // --- KPIs DE AGENTE ---
                function updateAgentKPIs(leads) {
                    if (user.role !== 'agent') return;
                    document.getElementById('agentMiniStats').style.display = 'grid';

                    const total = leads.length;
                    const contacted = leads.filter(l => l.status !== 'pending').length;
                    const closed = leads.filter(l => l.status === 'closed').length;
                    const today = leads.filter(l => {
                        const createdAt = new Date(l.created_at);
                        const now = new Date();
                        return createdAt.toDateString() === now.toDateString();
                    }).length;

                    const conv = total > 0 ? ((closed / total) * 100).toFixed(1) : '0.0';

                    document.getElementById('statLeadsTotal').textContent = total;
                    document.getElementById('statLeadsContacted').textContent = contacted;
                    document.getElementById('statLeadsConv').textContent = conv + '%';
                    document.getElementById('statLeadsToday').textContent = today;
                }

                // --- EXPORTAR A CSV ---
                function exportToCSV() {
                    const checks = document.querySelectorAll('.lead-checkbox:checked');
                    const ids = Array.from(checks).map(c => parseInt(c.value));
                    const dataToExport = ids.length > 0 ? allLeadsCache.filter(l => ids.includes(l.id)) : allLeadsCache;

                    if (dataToExport.length === 0) return alert('No hay datos para exportar');

                    const headers = ['ID', 'Nombre', 'Plataforma', 'URL', 'Seguidores', 'Avg Views', 'Pais', 'Nicho', 'Email', 'Estado', 'Ultima Nota'];
                    const rows = dataToExport.map(l => [
                        l.id,
                        l.name,
                        l.platform,
                        l.profile_url,
                        l.followers_count,
                        l.avg_views,
                        l.country,
                        l.niche,
                        l.email,
                        l.status,
                        (l.last_note || '').replace(/,/g, ';').replace(/\n/g, ' ')
                    ]);

                    let csvContent = "data:text/csv;charset=utf-8,"
                        + headers.join(",") + "\n"
                        + rows.map(e => e.join(",")).join("\n");

                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", `winton_leads_${new Date().toISOString().split('T')[0]}.csv`);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }

                // --- L√ìGICA DE SELECCI√ìN ---
                function toggleAllLeads(master) {
                    const checks = document.querySelectorAll('.lead-checkbox');
                    checks.forEach(c => c.checked = master.checked);
                    updateSelectionState();
                }

                function updateSelectionState() {
                    const checks = document.querySelectorAll('.lead-checkbox:checked');
                    const bar = document.getElementById('bulkActionBar');
                    const counter = document.getElementById('selectedCount');
                    const master = document.getElementById('selectAllLeads');
                    const allChecks = document.querySelectorAll('.lead-checkbox');

                    if (counter) counter.textContent = checks.length;
                    if (bar) {
                        if (checks.length > 0) bar.classList.add('active');
                        else bar.classList.remove('active');
                    }

                    if (master && allChecks.length > 0) {
                        master.checked = checks.length === allChecks.length;
                    }
                }

                function clearSelection() {
                    const master = document.getElementById('selectAllLeads');
                    if (master) {
                        master.checked = false;
                        toggleAllLeads(master);
                    }
                }

                // --- ACCIONES INDIVIDUALES / MASIVAS ---
                window.editLead = (l) => {
                    document.getElementById('leadModalTitle').textContent = 'Editar Prospecto';
                    document.getElementById('editLeadId').value = l.id;
                    document.getElementById('newLeadName').value = l.name;
                    document.getElementById('newLeadPlatform').value = l.platform;
                    document.getElementById('newLeadFollowers').value = l.followers_count;
                    document.getElementById('newLeadViews').value = l.avg_views;
                    document.getElementById('newLeadEmail').value = l.email || '';
                    document.getElementById('newLeadCountry').value = l.country || '';
                    document.getElementById('newLeadNiche').value = l.niche;
                    document.getElementById('newLeadUrl').value = l.profile_url;

                    openModal('createLeadModal');
                };

                async function bulkDeleteLeads() {
                    const checks = document.querySelectorAll('.lead-checkbox:checked');
                    const ids = Array.from(checks).map(c => parseInt(c.value));

                    if (!confirm(`¬øEst√°s seguro de que deseas eliminar ${ids.length} prospectos? Esta acci√≥n no se puede deshacer.`)) return;

                    try {
                        const res = await fetch(`${API_URL}/influencers/bulk`, {
                            method: 'DELETE',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                            body: JSON.stringify({ ids })
                        });
                        const result = await res.json();
                        alert(result.message);
                        loadLeads();
                    } catch (e) { console.error(e); alert('Error al eliminar'); }
                }

                async function bulkEditStatus() {
                    const checks = document.querySelectorAll('.lead-checkbox:checked');
                    const ids = Array.from(checks).map(c => parseInt(c.value));
                    const nextStatus = prompt("Ingresa el nuevo estado para estos leads\n(pending, contacted, negotiating, closed):", "contacted");

                    if (!nextStatus) return;

                    try {
                        const res = await fetch(`${API_URL}/influencers/interactions`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                            body: JSON.stringify({
                                leadIds: ids,
                                type: 'Cambio de estado masivo',
                                notes: 'Actualizaci√≥n por lote desde el panel principal',
                                new_status: nextStatus
                            })
                        });
                        if (res.ok) {
                            alert('Estados actualizados');
                            loadLeads();
                        }
                    } catch (e) { console.error(e); }
                }

                // --- LOGICA DE IMPORTACI√ìN MASIVA ---
                let validatedBulkData = [];

                async function validateImportBatch() {
                    const text = document.getElementById('bulkPasteArea').value.trim();
                    if (!text) return alert('Pega algo primero');

                    const lines = text.split('\n');
                    const items = lines.map(line => {
                        const cols = line.split('\t'); // Excel usa tabulaciones al copiar
                        return {
                            name: (cols[0] || '').trim(),
                            platform: (cols[1] || 'Instagram').trim(),
                            profile_url: (cols[2] || '').trim(),
                            followers_count: parseInt(cols[3]) || 0,
                            avg_views: parseInt(cols[4]) || 0,
                            country: (cols[5] || '').trim(),
                            niche: (cols[6] || '').trim(),
                            email: (cols[7] || '').trim()
                        };
                    }).filter(i => i.name && i.profile_url); // Solo l√≠neas con datos clave

                    if (items.length === 0) return alert('No se encontraron datos v√°lidos. Revisa el formato.');

                    try {
                        const res = await fetch(`${API_URL}/influencers/validate-batch`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                            body: JSON.stringify({ items })
                        });
                        validatedBulkData = await res.json();

                        renderBulkValidationView();
                    } catch (e) { console.error(e); alert('Error validando lote'); }
                }

                function renderBulkValidationView() {
                    document.getElementById('pasteStep').style.display = 'none';
                    document.getElementById('validationStep').style.display = 'flex';

                    const tbody = document.getElementById('bulkValidationTableBody');
                    tbody.innerHTML = '';

                    let safeCount = 0;
                    validatedBulkData.forEach(item => {
                        const isConflict = item.status === 'conflict';
                        if (!isConflict) safeCount++;

                        const tr = document.createElement('tr');
                        tr.style.borderBottom = '1px solid #1e293b';
                        if (isConflict) tr.style.background = 'rgba(239, 68, 68, 0.1)';

                        tr.innerHTML = `
                            <td style="padding:0.5rem;">${item.name}</td>
                            <td style="padding:0.5rem;">
                                <span style="color:${isConflict ? '#ef4444' : '#10b981'}; font-weight:bold;">
                                    ${isConflict ? '‚ùå CONFLICTO' : '‚úÖ LISTO'}
                                </span>
                            </td>
                            <td style="padding:0.5rem; color:${isConflict ? '#f87171' : '#94a3b8'};">
                                ${isConflict ? `Due√±o actual: <strong>${item.owner}</strong>` : 'Nuevo prospecto'}
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });

                    document.getElementById('safeCount').textContent = safeCount;
                    document.getElementById('confirmBulkBtn').disabled = safeCount === 0;
                }

                function resetBulkImport() {
                    document.getElementById('pasteStep').style.display = 'block';
                    document.getElementById('validationStep').style.display = 'none';
                    document.getElementById('bulkPasteArea').value = '';
                    validatedBulkData = [];
                }

                async function confirmBulkImport() {
                    const safeItems = validatedBulkData.filter(i => i.status === 'ok');
                    if (safeItems.length === 0) return;

                    try {
                        const res = await fetch(`${API_URL}/influencers/bulk-create`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                            body: JSON.stringify({ items: safeItems })
                        });

                        const result = await res.json();

                        if (res.ok) {
                            alert(result.message || 'Importaci√≥n completada con √©xito');
                            closeModal('bulkImportModal');
                            resetBulkImport();
                            loadLeads();
                        } else {
                            alert(result.error || 'Error al importar');
                        }
                    } catch (e) {
                        console.error(e);
                        alert('Error de conexi√≥n al importar');
                    }
                }


                // Reportes (Supervisi√≥n)
                window.openReportModal = async () => {
                    document.getElementById('reportsModal').style.display = 'flex';
                    await loadReports();
                };

                async function loadReports() {
                    try {
                        // Cargar Stats
                        const statsRes = await fetch(`${API_URL}/reports/stats`, { headers: { 'Authorization': `Bearer ${token}` } });
                        const stats = await statsRes.json();
                        document.getElementById('kpiTotal').textContent = stats.total_leads;
                        document.getElementById('kpiToday').textContent = stats.today_activity;
                        document.getElementById('kpiClosed').textContent = stats.closed_deals;

                        // Cargar Leaderboard
                        try {
                            const lbRes = await fetch(`${API_URL}/reports/leaderboard`, { headers: { 'Authorization': `Bearer ${token}` } });
                            const leaderboard = await lbRes.json();
                            const lbBody = document.getElementById('leaderboardBody');
                            if (lbBody) {
                                lbBody.innerHTML = '';
                                if (leaderboard.length === 0) {
                                    lbBody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:1rem;">Sin datos a√∫n</td></tr>';
                                } else {
                                    leaderboard.forEach(ag => {
                                        const tr = document.createElement('tr');
                                        tr.style.borderBottom = '1px solid #374151';
                                        const lastActive = ag.last_activity
                                            ? new Date(ag.last_activity).toLocaleString([], { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })
                                            : '-';

                                        tr.innerHTML = `
                                    <td style="padding:0.75rem; font-weight:bold;">
                                        <a href="#" onclick="openAgentAudit(${ag.agent_id}); return false;" style="color:var(--primary); text-decoration:none;">${ag.username} ‚Üó</a>
                                    </td>
                                    <td style="padding:0.75rem; text-align:center;">${ag.assigned_leads || 0}</td>
                                    <td style="padding:0.75rem; text-align:center;">${ag.closed_deals || 0}</td>
                                    <td style="padding:0.75rem; text-align:right; color:#9ca3af;">${lastActive}</td>
                                `;
                                        lbBody.appendChild(tr);
                                    });
                                }
                            }
                        } catch (e) { console.error('Error leaderboard', e); }

                        // Cargar Feed
                        const feedRes = await fetch(`${API_URL}/reports/feed`, { headers: { 'Authorization': `Bearer ${token}` } });
                        const feed = await feedRes.json();
                        const tbody = document.getElementById('activityTableBody');
                        tbody.innerHTML = '';

                        if (feed.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="5" style="padding:1rem; text-align:center; color:#9ca3af;">Sin actividad reciente</td></tr>';
                            return;
                        }

                        feed.forEach(log => {
                            const row = document.createElement('tr');
                            row.style.borderBottom = '1px solid #374151';
                            const date = new Date(log.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                            row.innerHTML = `
                        <td style="padding:0.75rem; color:#9ca3af;">${date}</td>
                        <td style="padding:0.75rem; font-weight:bold;">${log.agent_name}</td>
                        <td style="padding:0.75rem;">${log.influencer_name} <span style="font-size:0.8rem; color:#6b7280;">(${log.platform})</span></td>
                        <td style="padding:0.75rem;"><span class="status-badge status-pending">${log.action_type}</span></td>
                        <td style="padding:0.75rem; color:#d1d5db; max-width:200px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${log.notes || '-'}</td>
                    `;
                            tbody.appendChild(row);
                        });

                    } catch (e) { console.error("Error reports", e); }
                }

                // AUDITOR√çA DE AGENTE
                window.openAgentAudit = async (agentId) => {
                    document.getElementById('agentDetailModal').style.display = 'flex';
                    document.getElementById('auditAgentTitle').textContent = 'Cargando...';
                    document.getElementById('auditLeadsList').innerHTML = '<div style="padding:1rem;">Cargando...</div>';
                    document.getElementById('auditHistoryList').innerHTML = '<div style="padding:1rem;">Cargando...</div>';

                    try {
                        const res = await fetch(`${API_URL}/reports/agent/${agentId}`, { headers: { 'Authorization': `Bearer ${token}` } });
                        const data = await res.json();

                        if (data.error) return alert(data.error);

                        // 1. Header
                        document.getElementById('auditAgentTitle').textContent = `Auditor√≠a: ${data.agent.username}`;

                        // 2. Leads List
                        const leadsContainer = document.getElementById('auditLeadsList');
                        leadsContainer.innerHTML = '';
                        if (data.leads.length === 0) {
                            leadsContainer.innerHTML = '<div style="padding:1rem; color:#6b7280;">Sin leads asignados</div>';
                        } else {
                            data.leads.forEach(l => {
                                const item = document.createElement('div');
                                item.style.padding = '0.75rem';
                                item.style.borderBottom = '1px solid #374151';
                                item.style.background = '#1e293b';
                                item.style.marginBottom = '0.5rem';
                                item.style.borderRadius = '0.375rem';
                                item.innerHTML = `
                            <div style="font-weight:bold; display:flex; justify-content:space-between;">
                                ${l.name} <span class="status-badge status-${l.status}" style="font-size:0.7rem;">${l.status}</span>
                            </div>
                            <div style="font-size:0.85rem; color:#9ca3af;">${l.platform} ‚Ä¢ ${l.followers_count} segs</div>
                            <a href="${l.profile_url}" target="_blank" style="font-size:0.8rem; color:var(--primary);">Ver Perfil</a>
                        `;
                                leadsContainer.appendChild(item);
                            });
                        }

                        // 3. History Timeline
                        const historyContainer = document.getElementById('auditHistoryList');
                        historyContainer.innerHTML = '';
                        if (data.history.length === 0) {
                            historyContainer.innerHTML = '<div style="padding:1rem; color:#6b7280;">Sin actividad registrada</div>';
                        } else {
                            data.history.forEach(h => {
                                const time = new Date(h.created_at).toLocaleString([], { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                                const item = document.createElement('div');
                                item.style.padding = '0.75rem';
                                item.style.borderLeft = '2px solid var(--warning)';
                                item.style.background = '#1e293b';
                                item.style.marginBottom = '0.5rem';
                                item.style.marginLeft = '0.5rem';
                                item.innerHTML = `
                            <div style="font-size:0.8rem; color:#6b7280; margin-bottom:0.25rem;">${time}</div>
                            <div style="font-weight:bold; color:#e2e8f0;">${h.type.replace('_', ' ').toUpperCase()}</div>
                            <input type="text" value="${h.influencer_name}" disabled style="background:transparent; border:none; color:var(--primary); padding:0; margin:0; font-size:0.9rem; font-weight:600;">
                            <div style="font-size:0.9rem; color:#cbd5e1; margin-top:0.25rem; font-style:italic;">"${h.notes || ''}"</div>
                            ${h.screenshot_url ? `<a href="${h.screenshot_url}" target="_blank" style="font-size:0.8rem; color:#60a5fa; display:block; margin-top:0.5rem;">üì∑ Ver Screenshot</a>` : ''}
                        `;
                                historyContainer.appendChild(item);
                            });
                        }

                    } catch (err) {
                        console.error(err);
                        alert('Error cargando detalle de agente');
                    }
                };

                // ======= GESTI√ìN DE EQUIPO =======
                window.openTeamModal = async () => {
                    document.getElementById('teamModal').style.display = 'flex';
                    await loadTeam();
                };

                async function loadTeam() {
                    try {
                        const res = await fetch(`${API_URL}/auth/agents`, { headers: { 'Authorization': `Bearer ${token}` } });
                        const agents = await res.json();
                        const tbody = document.getElementById('teamListBody');
                        tbody.innerHTML = '';

                        if (agents.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:1rem; color:#9ca3af;">Sin agentes registrados</td></tr>';
                            return;
                        }

                        agents.forEach(a => {
                            const row = document.createElement('tr');
                            row.style.borderBottom = '1px solid #374151';
                            const joined = new Date(a.created_at).toLocaleDateString();

                            row.innerHTML = `
                        <td style="padding:0.75rem; font-weight:bold;">${a.username}</td>
                        <td style="padding:0.75rem; color:#9ca3af; text-transform:capitalize;">${a.role}</td>
                        <td style="padding:0.75rem; color:#6b7280;">${joined}</td>
                        <td style="padding:0.75rem; text-align:right;">
                            <button class="icon-btn" onclick="openChangePass(${a.id}, '${a.username}')" title="Cambiar Contrase√±a"><i class="ph ph-key"></i> üîë</button>
                            <button class="icon-btn" onclick="deleteAgent(${a.id})" title="Eliminar" style="color:#ef4444;"><i class="ph ph-trash"></i> üóëÔ∏è</button>
                        </td>
                    `;
                            tbody.appendChild(row);
                        });
                    } catch (err) { console.error('Error cargando equipo', err); }
                }

                window.deleteAgent = async (id) => {
                    if (!confirm('‚ö†Ô∏è ¬øEst√°s seguro de eliminar este agente?\nSus leads quedar√°n sin asignar.')) return;
                    try {
                        await fetch(`${API_URL}/auth/agents/${id}`, {
                            method: 'DELETE',
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        loadTeam();
                    } catch (err) { alert('Error eliminando agente'); }
                };

                window.openChangePass = (id, name) => {
                    document.getElementById('cpAgentId').value = id;
                    document.getElementById('cpAgentName').textContent = `Agente: ${name}`;
                    document.getElementById('cpNewPass').value = '';
                    document.getElementById('changePasswordModal').style.display = 'flex';
                };

                window.submitNewPassword = async () => {
                    const id = document.getElementById('cpAgentId').value;
                    const newPass = document.getElementById('cpNewPass').value;
                    if (!newPass) return alert('Ingresa una contrase√±a');

                    try {
                        await fetch(`${API_URL}/auth/agents/${id}/password`, {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({ newPassword: newPass })
                        });
                        alert('Contrase√±a actualizada');
                        closeModal('changePasswordModal');
                    } catch (err) { alert('Error actualizando contrase√±a'); }
                };

                // Listeners Formularios Lead/Agente (Sin cambios de l√≥gica)
                window.openActionModal = (id, name) => {
                    document.getElementById('actionLeadId').value = id;
                    document.getElementById('actionLeadName').textContent = name;
                    openModal('actionModal');
                };

                // Listener Crear/Editar Lead (Controlador Centralizado)
                document.getElementById('createLeadForm').addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const editId = document.getElementById('editLeadId').value;
                    const method = editId ? 'PUT' : 'POST';
                    const endpoint = editId ? `${API_URL}/influencers/${editId}` : `${API_URL}/influencers`;

                    const data = {
                        name: document.getElementById('newLeadName').value,
                        platform: document.getElementById('newLeadPlatform').value,
                        profile_url: document.getElementById('newLeadUrl').value,
                        followers_count: document.getElementById('newLeadFollowers').value,
                        avg_views: document.getElementById('newLeadViews').value,
                        email: document.getElementById('newLeadEmail').value,
                        country: document.getElementById('newLeadCountry').value,
                        niche: document.getElementById('newLeadNiche').value,
                        status: editId ? undefined : 'pending' // Mantener estado si es edici√≥n
                    };

                    try {
                        const res = await fetch(endpoint, {
                            method: method,
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                            body: JSON.stringify(data)
                        });

                        if (!res.ok) {
                            const err = await res.json();
                            return alert(err.error || 'Error en la operaci√≥n');
                        }

                        alert(editId ? 'Prospecto actualizado con √©xito' : 'Prospecto creado exitosamente');
                        closeModal('createLeadModal');
                        loadLeads();
                    } catch (e) { alert('Error de conexi√≥n'); }
                });

                // Funci√≥n auxiliar para resetear modal al abrir para "Nuevo"
                window.openCreateLeadModal = () => {
                    document.getElementById('leadModalTitle').textContent = 'Nuevo Prospecto';
                    document.getElementById('editLeadId').value = '';
                    document.getElementById('createLeadForm').reset();
                    openModal('createLeadModal');
                };

                document.getElementById('actionForm').addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const submitBtn = e.target.querySelector('button[type="submit"]');
                    if (submitBtn) submitBtn.disabled = true;

                    const data = {
                        leadIds: [document.getElementById('actionLeadId').value],
                        type: document.getElementById('actionType').value,
                        new_status: document.getElementById('actionNewStatus').value,
                        notes: document.getElementById('actionNotes').value,
                        screenshot_url: document.getElementById('actionScreenshotUrl').value,
                        budget_offer: document.getElementById('actionBudget').value || null
                    };

                    try {
                        const res = await fetch(`${API_URL}/influencers/interactions`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                            body: JSON.stringify(data)
                        });

                        if (res.ok) {
                            alert('Actividad registrada correctamente');
                            closeModal('actionModal');
                            loadLeads();
                        } else {
                            const errorData = await res.json();
                            alert('Error del servidor: ' + (errorData.error || 'No se pudo guardar la actividad'));
                        }
                    } catch (err) {
                        console.error('Error al registrar actividad:', err);
                        alert('Error de conexi√≥n. Verifica tu internet o el estado del servidor.');
                    } finally {
                        if (submitBtn) submitBtn.disabled = false;
                    }
                });

                document.getElementById('createAgentForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const u = document.getElementById('agUser').value; const p = document.getElementById('agPass').value;
                    await fetch(`${API_URL}/auth/register`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify({ username: u, password: p, role: 'agent' }) });
                    closeModal('createAgentModal');
                });

                document.getElementById('logoutBtn').addEventListener('click', () => { localStorage.clear(); location.href = 'index.html'; });

                // Listener Crear Campa√±a
                document.getElementById('createCampaignForm').addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const name = document.getElementById('newCampName').value;
                    const desc = document.getElementById('newCampDesc').value;

                    const target_config = {
                        platform: document.getElementById('targetPlatform').value,
                        geo: document.getElementById('targetGeo').value,
                        followers: document.getElementById('targetFollowers').value,
                        budget: document.getElementById('targetBudget').value,
                        niche: document.getElementById('targetNiche').value
                    };

                    try {
                        const res = await fetch(`${API_URL}/campaigns`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                            body: JSON.stringify({ name, description: desc, target_config })
                        });

                        if (res.ok) {
                            closeModal('createCampaignModal');
                            loadCampaigns();
                            // Limpiar form
                            e.target.reset();
                        } else {
                            alert('Error creando campa√±a');
                        }
                    } catch (err) { console.error(err); alert('Error de conexi√≥n'); }
                });

                // ======= DASHBOARD ADMIN (SUPER VISI√ìN) =======
                async function loadAgentsDashboard() {
                    const grid = document.getElementById('agentsGrid');
                    grid.innerHTML = '<div style="text-align:center; padding:2rem; width:100%;">Cargando m√©tricas del equipo...</div>';

                    try {
                        const res = await fetch(`${API_URL}/reports/leaderboard`, { headers: { 'Authorization': `Bearer ${token}` } });
                        const agents = await res.json();

                        grid.innerHTML = '';
                        if (agents.length === 0) {
                            grid.innerHTML = '<div style="text-align:center; padding:2rem; width:100%;">No hay agentes registrados.</div>';
                            return;
                        }

                        agents.forEach(ag => {
                            const lastActive = ag.last_activity
                                ? new Date(ag.last_activity).toLocaleString([], { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })
                                : 'Sin actividad';

                            const card = document.createElement('div');
                            card.className = 'card';
                            card.style.cursor = 'pointer';
                            card.style.transition = 'transform 0.2s, border 0.2s';
                            card.onmouseover = () => { card.style.transform = 'translateY(-3px)'; card.style.borderColor = 'var(--primary)'; };
                            card.onmouseout = () => { card.style.transform = 'none'; card.style.borderColor = 'transparent'; };
                            card.onclick = () => openAgentAudit(ag.agent_id);

                            card.innerHTML = `
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <h3 style="margin:0;">${ag.username}</h3>
                            <span style="font-size:1.2rem;">üë§</span>
                        </div>
                        <div style="margin-top:1.5rem; display:grid; grid-template-columns: 1fr 1fr; gap:1rem; text-align:center;">
                            <div style="padding:0.5rem; background:#1f2937; border-radius:0.5rem;">
                                <div style="font-size:0.8rem; color:#9ca3af;">Leads</div>
                                <div style="font-size:1.5rem; font-weight:bold;">${ag.assigned_leads}</div>
                            </div>
                            <div style="padding:0.5rem; background:#1f2937; border-radius:0.5rem;">
                                <div style="font-size:0.8rem; color:#9ca3af;">Ventas</div>
                                <div style="font-size:1.5rem; font-weight:bold; color:var(--success);">${ag.closed_deals}</div>
                            </div>
                        </div>
                        <div style="margin-top:1rem; padding-top:1rem; border-top:1px solid #374151; font-size:0.85rem; color:#9ca3af; display:flex; justify-content:space-between;">
                            <span>√öltima vez:</span>
                            <span style="color:#e2e8f0;">${lastActive}</span>
                        </div>
                    `;
                            grid.appendChild(card);
                        });
                    } catch (e) { console.error(e); grid.innerHTML = 'Error cargando dashboard.'; }
                }

                // ======= LOGICA PERFIL AGENTE =======
                let currentAgentData = { leads: [], history: [] };

                window.openAgentAudit = async (agentId) => {
                    document.getElementById('adminDashboardView').style.display = 'none';
                    document.getElementById('agentDashboardView').style.display = 'none';
                    document.getElementById('agentFullProfileView').style.display = 'block';

                    // Reset UI
                    document.getElementById('fpAgentName').textContent = 'Cargando...';
                    document.getElementById('fpLeadsBody').innerHTML = '<tr><td colspan="5" style="text-align:center; padding:2rem;">Cargando datos...</td></tr>';
                    document.getElementById('fpInspectorContent').innerHTML = '<div style="text-align:center; color:#9ca3af;">Cargando feed...</div>';

                    try {
                        const res = await fetch(`${API_URL}/reports/agent/${agentId}`, { headers: { 'Authorization': `Bearer ${token}` } });
                        const data = await res.json();

                        if (data.error) { alert(data.error); initDashboard(); return; }

                        currentAgentData = data;

                        // Header
                        document.getElementById('fpAgentName').textContent = data.agent.username;
                        document.getElementById('fpAgentId').textContent = data.agent.id;
                        document.getElementById('fpAgentJoined').textContent = new Date(data.agent.created_at).toLocaleDateString();

                        // KPIs
                        const total = data.leads.length;
                        const contacted = data.leads.filter(l => l.status === 'contacted' || l.status === 'negotiating' || l.status === 'closed').length;
                        const closed = data.leads.filter(l => l.status === 'closed').length;
                        const conversion = total > 0 ? ((closed / total) * 100).toFixed(1) : '0.0';

                        document.getElementById('fpStatTotal').textContent = total;
                        document.getElementById('fpStatContacted').textContent = contacted;
                        document.getElementById('fpStatClosed').textContent = closed;
                        document.getElementById('fpStatConversion').textContent = conversion + '%';

                        // Render Tables
                        renderAgentLeads(data.leads);
                        renderHistoryFeed(data.history, 'üì° Feed Global');

                    } catch (err) {
                        console.error(err);
                        initDashboard();
                    }
                };

                function renderAgentLeads(leads) {
                    const tbody = document.getElementById('fpLeadsBody');
                    tbody.innerHTML = '';

                    if (leads.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:2rem; color:#9ca3af;">Sin leads asignados</td></tr>';
                        return;
                    }

                    leads.forEach(l => {
                        const tr = document.createElement('tr');
                        tr.style.borderBottom = '1px solid #374151';
                        tr.style.cursor = 'pointer';
                        tr.onmouseover = () => tr.style.background = '#1f2937';
                        tr.onmouseout = () => tr.style.background = 'transparent';
                        tr.onclick = () => showLeadDetails(l.id, l.name);

                        tr.innerHTML = `
                    <td style="padding:0.75rem; font-weight:bold;">${l.name}</td>
                    <td style="padding:0.75rem;"><span style="font-size:0.8rem; color:#9ca3af;">${l.platform}</span><br><span style="font-size:0.75rem; color:#6b7280;">${l.country || '-'}</span></td>
                    <td style="padding:0.75rem; text-align:center;"><span class="badge" style="background:#374151;">${l.niche || '-'}</span></td>
                    <td style="padding:0.75rem; text-align:center;"><span class="status-badge status-${l.status}" style="font-size:0.8rem;">${l.status}</span></td>
                    <td style="padding:0.75rem; text-align:right;">
                        <a href="${l.profile_url}" target="_blank" onclick="event.stopPropagation()" style="color:var(--primary); font-size:0.8rem;">üîó Link</a>
                    </td>
                `;
                        tbody.appendChild(tr);
                    });
                }

                function renderHistoryFeed(history, title) {
                    const container = document.getElementById('fpInspectorContent');
                    document.getElementById('fpInspectorTitle').textContent = title;
                    container.innerHTML = '';

                    if (history.length === 0) {
                        container.innerHTML = '<div style="text-align:center; padding:2rem; color:#6b7280;">Sin actividad registrada.</div>';
                        return;
                    }

                    history.forEach(h => {
                        const time = new Date(h.created_at).toLocaleString([], { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                        const typeLabel = h.type === 'initial_message' ? 'PRIMER CONTACTO' : h.type.replace(/_/g, ' ').toUpperCase();

                        const item = document.createElement('div');
                        item.style.padding = '0.75rem';
                        item.style.background = '#1e293b';
                        item.style.borderRadius = '0.5rem';
                        item.style.borderLeft = `3px solid ${h.type.includes('message') ? 'var(--primary)' : 'var(--warning)'}`;

                        item.innerHTML = `
                    <div style="display:flex; justify-content:space-between; font-size:0.75rem; color:#9ca3af; margin-bottom:0.25rem;">
                        <span>${time}</span>
                        ${title.includes('Global') ? `<span style="color:#e2e8f0;">${h.influencer_name}</span>` : ''}
                    </div>
                    <div style="font-weight:bold; color:#f3f4f6; font-size:0.9rem;">${typeLabel}</div>
                    <div style="color:#d1d5db; font-size:0.85rem; margin-top:0.25rem; font-style:italic;">"${h.notes || ''}"</div>
                    ${h.screenshot_url ? `<a href="${h.screenshot_url}" target="_blank" style="display:block; margin-top:0.5rem; font-size:0.75rem; color:#60a5fa;">üì∑ Ver Evidencia</a>` : ''}
                `;
                        container.appendChild(item);
                    });
                }

                window.showLeadDetails = (leadId, leadName) => {
                    const leadHistory = currentAgentData.history.filter(h => h.influencer_id == leadId);
                    renderHistoryFeed(leadHistory, `üìú Historial: ${leadName}`);
                };

                window.filterAgentLeads = (text) => {
                    const term = text.toLowerCase();
                    const filtered = currentAgentData.leads.filter(l =>
                        l.name.toLowerCase().includes(term) ||
                        (l.niche && l.niche.toLowerCase().includes(term)) ||
                        (l.country && l.country.toLowerCase().includes(term)) ||
                        l.status.includes(term)
                    );
                    renderAgentLeads(filtered);
                };

                function initDashboard() {
                    loadCampaigns();
                    document.getElementById('agentFullProfileView').style.display = 'none';

                    if (user.role === 'admin') {
                        document.getElementById('adminDashboardView').style.display = 'block';
                        document.getElementById('agentDashboardView').style.display = 'none';
                        loadAgentsDashboard();
                    } else {
                        document.getElementById('adminDashboardView').style.display = 'none';
                        document.getElementById('agentDashboardView').style.display = 'block';
                        loadLeads();
                    }
                }

                // Iniciar
                initDashboard();
            </script>
            <style>
                /* MOBILE RESPONSIVE OVERRIDES */
                #mobileScriptToggle {
                    display: none;
                    /* Hide on Desktop */
                    width: 100%;
                    padding: 1rem;
                    background: #1f2937;
                    color: white;
                    border: none;
                    border-bottom: 1px solid #374151;
                    font-size: 1rem;
                    font-weight: bold;
                    cursor: pointer;
                    text-align: center;
                }

                @media (max-width: 768px) {
                    body {
                        flex-direction: column;
                        overflow-y: auto;
                        height: auto;
                    }

                    /* Sidebar Hidden by Default */
                    .sidebar {
                        width: 100%;
                        height: auto;
                        max-height: 0;
                        overflow: hidden;
                        transition: max-height 0.3s ease-in-out;
                        border-bottom: 1px solid #374151;
                        border-right: none;
                        flex-shrink: 0;
                    }

                    /* Sidebar Visible when Active */
                    .sidebar.active {
                        max-height: 60vh;
                        /* 60% of screen */
                        overflow-y: auto;
                        border-bottom: 2px solid var(--primary);
                    }

                    /* Toggle Button Visible */
                    #mobileScriptToggle {
                        display: block;
                    }

                    .main-content {
                        padding: 1rem;
                        height: auto;
                        overflow: visible;
                        width: 100%;
                    }

                    /* Single Column Grid */
                    .grid {
                        grid-template-columns: 1fr;
                    }

                    /* Header Stack */
                    header {
                        flex-direction: column;
                        gap: 1rem;
                        align-items: flex-start;
                    }

                    header>div {
                        width: 100%;
                        display: flex;
                        flex-direction: column;
                        gap: 0.5rem;
                    }

                    /* Big Buttons */
                    .btn {
                        width: 100%;
                        padding: 0.75rem;
                        font-size: 1rem;
                    }

                    /* Full Screen Modals */
                    .modal-content {
                        width: 100%;
                        height: 100%;
                        max-width: none;
                        border-radius: 0;
                        padding: 1rem;
                        overflow-y: auto;
                        margin: 0;
                    }

                    /* Better Inputs */
                    input,
                    select,
                    textarea {
                        font-size: 16px;
                        /* Stop iOS zoom */
                        padding: 0.8rem;
                    }
                }
            </style>
</body>

</html>